<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quiz: Nest, TypeORM, DTO, Guards, JWT, Roles</title>
    <style>
        :root {
            --bg: #0f1724;
            --card: #0b1220;
            --accent: #06b6d4;
            --muted: #94a3b8;
            --ok: #10b981;
            --bad: #ef4444
        }

        * {
            box-sizing: border-box;
            font-family: Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, 'Helvetica Neue', Arial
        }

        body {
            margin: 0;
            background: linear-gradient(180deg, #071026 0%, #071422 100%);
            color: #e6eef6;
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 28px
        }

        .app {
            width: 100%;
            max-width: 1100px
        }

        header {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 18px
        }

        h1 {
            font-size: 20px;
            margin: 0
        }

        .controls {
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.6);
        }

        .grid {
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 14px
        }

        .left {
            min-height: 480px
        }

        .participants {
            max-height: 420px;
            overflow: auto;
            margin-top: 12px
        }

        .person {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 6px;
            background: rgba(255, 255, 255, 0.02)
        }

        label {
            font-size: 13px;
            color: var(--muted)
        }

        select,
        input {
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            background: transparent;
            color: inherit
        }

        .question-area {
            display: flex;
            flex-direction: column;
            gap: 10px
        }

        .question {
            font-weight: 600
        }

        .answers {
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        button {
            cursor: pointer;
            padding: 10px 12px;
            border-radius: 10px;
            border: 0;
            background: var(--accent);
            color: #00202a;
            font-weight: 700
        }

        .secondary {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: var(--muted);
            font-weight: 600
        }

        .small {
            font-size: 13px;
            padding: 6px 8px
        }

        .summary {
            margin-top: 12px
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th,
        td {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
            text-align: left
        }

        .correct {
            color: var(--ok);
            font-weight: 700
        }

        .wrong {
            color: var(--bad);
            font-weight: 700
        }

        .muted {
            color: var(--muted)
        }

        footer {
            margin-top: 12px;
            color: var(--muted);
            font-size: 13px
        }

        @media(max-width:900px) {
            .grid {
                grid-template-columns: 1fr
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <header>
            <div>
                <h1>Quiz: NestJS / TypeORM / DTO / Guards / JWT / Roles</h1>
                <div class="muted">48 preguntas — cada persona puede responder hasta 3 preguntas</div>
            </div>
            <div class="controls card">
                <label>Participantes (2–24)</label>
                <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
                    <input id="numParticipants" type="number" min="3" max="24" value="24" style="width:84px" />
                    <button id="resetParticipants" class="small secondary">Actualizar</button>
                </div>
            </div>
        </header>

        <div class="grid">
            <div class="left card">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <label>Pregunta actual</label>
                        <div id="qIndex" class="muted">0 / 48</div>
                    </div>
                    <div>
                        <label>Seleccionar persona</label>
                        <select id="personSelect"></select>
                    </div>
                </div>

                <div class="question-area" style="margin-top:12px">
                    <div class="question" id="questionText">Pulsa "Siguiente pregunta" para empezar</div>
                    <div class="answers" id="answers"></div>
                    <div style="display:flex;gap:8px;margin-top:8px">
                        <button id="nextBtn">Siguiente pregunta</button>
                        <button id="submitBtn" class="small secondary" disabled>Enviar respuesta</button>
                        <button id="finishBtn" class="small secondary">Finalizar y ver resultados</button>
                    </div>
                    <div id="info" class="muted" style="margin-top:8px"></div>
                </div>

                <div class="summary">
                    <label>Historial (últimas 6 respuestas)</label>
                    <div id="history" class="muted" style="margin-top:8px"></div>
                </div>
            </div>

            <div class="right card">
                <label>Participantes</label>
                <div class="participants" id="participantsList"></div>
                <div style="display:flex;gap:8px;margin-top:10px">
                    <button id="showAllResults" class="small">Mostrar resumen final</button>
                    <button id="exportCSV" class="small secondary">Exportar CSV</button>
                </div>
                <footer>Nota: por defecto hay 24 participantes (cada uno puede responder 3 preguntas). Puedes ajustar el
                    número arriba.</footer>
            </div>
        </div>

        <!-- Modal summary -->
        <div id="modal"
            style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center">
            <div
                style="width:90%;max-width:980px;max-height:90%;overflow:auto;padding:18px;border-radius:12px;background:linear-gradient(180deg,#071422,#071026)">
                <h2>Resumen final</h2>
                <div id="finalTable"></div>
                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                    <button id="closeModal" class="small secondary">Cerrar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ======== Preguntas (48) ========
        const questions = [
            {
                q: '¿Cuál es la función principal de un Controller en NestJS?',
                choices: [
                    'Manejar la lógica de negocio de la aplicación',
                    'Definir las rutas y manejar las peticiones HTTP',
                    'Configurar los módulos de la aplicación',
                    'Gestionar las conexiones a la base de datos'
                ],
                a: 1
            },

            {
                q: '¿Qué propósito tiene un Guard en NestJS?',
                choices: [
                    'Validar datos de entrada en DTOs',
                    'Proteger rutas y controlar el acceso según condiciones o roles',
                    'Interceptar respuestas antes de enviarlas al cliente',
                    'Ejecutar tareas en segundo plano'
                ],
                a: 1
            },

            {
                q: '¿Qué contiene normalmente un Service en NestJS?',
                choices: [
                    'Decoradores de rutas y middlewares',
                    'Configuraciones globales de la aplicación',
                    'Lógica de negocio reutilizable y comunicación con repositorios o APIs',
                    'Filtros de excepciones y pipes personalizados'
                ],
                a: 2
            }
        ];

        // ======== Estado ========
        let numParticipants = parseInt(document.getElementById('numParticipants').value, 10) || 24;
        let participants = [];
        let currentIndex = -1; // índice de pregunta actual
        let history = [];

        function initParticipants() {
            participants = [];
            for (let i = 1; i <= numParticipants; i++) {
                participants.push({ id: i, answers: [], remaining: 3 });
            }
            renderParticipants();
            populatePersonSelect();
        }

        function renderParticipants() {
            const container = document.getElementById('participantsList');
            container.innerHTML = '';
            participants.forEach(p => {
                const div = document.createElement('div');
                div.className = 'person';
                div.innerHTML = `<div>Persona ${p.id}</div><div class=muted>Respuestas: ${p.answers.length}/3</div>`;
                container.appendChild(div);
            })
        }

        function populatePersonSelect() {
            const sel = document.getElementById('personSelect');
            sel.innerHTML = '';
            participants.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `Persona ${p.id} (${p.answers.length}/3)`;
                if (p.answers.length >= 3) opt.disabled = true;
                sel.appendChild(opt);
            })
        }

        function renderQuestion(i) {
            const q = questions[i];
            document.getElementById('qIndex').textContent = `${i + 1} / ${questions.length}`;
            document.getElementById('questionText').textContent = q.q;
            const answers = document.getElementById('answers'); answers.innerHTML = '';
            q.choices.forEach((c, idx) => {
                const btn = document.createElement('button');
                btn.className = 'secondary'; btn.style.textAlign = 'left'; btn.dataset.idx = idx;
                btn.textContent = c;
                btn.addEventListener('click', () => {
                    selectAnswer(idx);
                    // highlight
                    Array.from(answers.children).forEach(ch => ch.style.border = '1px solid rgba(255,255,255,0.04)');
                    btn.style.border = `2px solid rgba(6,182,212,0.9)`;
                });
                answers.appendChild(btn);
            });
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('info').textContent = 'Elige la persona y selecciona una respuesta.';
        }

        let chosenIdx = null;
        function selectAnswer(idx) { chosenIdx = idx; }

        document.getElementById('nextBtn').addEventListener('click', () => {
            // avanzar índice a próxima pregunta no respondida (o aleatoria)
            if (currentIndex >= questions.length - 1) { alert('Ya llegaste al final de las preguntas.'); return; }
            currentIndex++;
            renderQuestion(currentIndex);
            chosenIdx = null;
        });

        document.getElementById('submitBtn').addEventListener('click', () => {
            const sel = document.getElementById('personSelect');
            const pid = parseInt(sel.value, 10);
            const person = participants.find(p => p.id === pid);
            if (!person) { alert('Selecciona una persona válida'); return; }
            if (person.answers.length >= 3) { alert('Esta persona ya respondió 3 preguntas'); populatePersonSelect(); return; }
            if (chosenIdx === null) { alert('Selecciona una respuesta antes de enviar'); return; }
            // registrar
            const q = questions[currentIndex];
            const correct = chosenIdx === q.a;
            person.answers.push({ qIndex: currentIndex, answer: chosenIdx, correct });
            person.remaining = 3 - person.answers.length;

            history.unshift(`P${person.id} — P${currentIndex + 1}: ${correct ? '✅ Correcta' : '❌ Incorrecta'}`);
            if (history.length > 6) history.pop();
            document.getElementById('history').textContent = history.join('\n');
            renderParticipants();
            populatePersonSelect();
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('info').textContent = `Respuesta registrada para Persona ${person.id}. ${person.remaining} respuestas restantes.`;
        });

        document.getElementById('finishBtn').addEventListener('click', () => { showFinalSummary(); });
        document.getElementById('showAllResults').addEventListener('click', () => { showFinalSummary(); });
        document.getElementById('closeModal').addEventListener('click', () => { document.getElementById('modal').style.display = 'none' });

        document.getElementById('resetParticipants').addEventListener('click', () => {
            const v = parseInt(document.getElementById('numParticipants').value, 10);
            if (isNaN(v) || v < 3 || v > 24) { alert('Número válido entre 3 y 24'); return; }
            numParticipants = v;
            initParticipants();
        });

        function showFinalSummary() {
            const modal = document.getElementById('modal');
            const container = document.getElementById('finalTable');
            // build table
            let html = '<table><thead><tr><th>Persona</th><th>Preguntas respondidas (número)</th><th>Respuestas (correcta/incorrecta)</th><th>Correctas</th></tr></thead><tbody>';
            participants.forEach(p => {
                const qnums = p.answers.map(a => a.qIndex + 1).join(', ') || '-';
                const answers = p.answers.map(a => `${a.answer + 1} (${a.correct ? 'OK' : 'NO'})`).join(', ') || '-';
                const correctCount = p.answers.filter(a => a.correct).length;
                html += `<tr><td>Persona ${p.id}</td><td>${qnums}</td><td>${answers}</td><td class="${correctCount > 0 ? 'correct' : 'muted'}">${correctCount}</td></tr>`;
            });
            html += '</tbody></table>';
            // resumen general
            const totalAnswered = participants.reduce((s, p) => s + p.answers.length, 0);
            const totalCorrect = participants.reduce((s, p) => s + p.answers.filter(a => a.correct).length, 0);
            html = `<div class="muted">Total respuestas: ${totalAnswered} / 48 — Correctas: ${totalCorrect}</div>` + html;
            container.innerHTML = html;
            modal.style.display = 'flex';
        }

        document.getElementById('exportCSV').addEventListener('click', () => {
            // simple CSV: persona, qIndex+1, answerIndex+1, correct
            let lines = ['persona,qIndex,answer,correct'];
            participants.forEach(p => {
                p.answers.forEach(a => {
                    lines.push([p.id, a.qIndex + 1, a.answer + 1, a.correct].join(','));
                })
            });
            const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'quiz_responses.csv'; a.click(); URL.revokeObjectURL(url);
        });

        // Inicializar
        initParticipants();
        // autopasar a primera pregunta para comodidad
        currentIndex = 0; renderQuestion(currentIndex);

    </script>
</body>

</html>